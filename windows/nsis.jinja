!define PRODUCT_VERSION "{{ MAJOR_VERSION_NUM }}.0"
!define PRODUCT_PUBLISHER "{{ ORG }}"
; PT:SERVICE
!define displayName "{{ MAJOR_VERSION }}"
!define serviceName "{{ MAJOR_VERSION }}"
; PT:SERVICE


;Require admin rights on NT6+ (When UAC is turned on)
RequestExecutionLevel admin

SetCompressor /SOLID lzma

Name "{{ MAJOR_VERSION }} {{ MINOR_VERSION }}"
OutFile "dist\{{ MAJOR_VERSION }}-{{ MINOR_VERSION }}-win64-installer.exe"
InstallDir "$PROGRAMFILES64\{{ ORG }}\{{ MAJOR_VERSION }}"

;--------------------------------
;Interface Settings
  !define MUI_ABORTWARNING
  !define MUI_LICENSEPAGE_CHECKBOX
  ; PT:QT
  !define MUI_FINISHPAGE_RUN "$INSTDIR\{{ MAJOR_VERSION }}_qt\{{ MAJOR_VERSION }}_qt.exe"
  ; PT:QT
  !define MUI_STARTMENUPAGE_DEFAULTFOLDER "{{ MAJOR_VERSION }}"

!include MUI2.nsh
!include WinVer.nsh
!include x64.nsh

;--------------------------------
;Modern UI Configuration
;Installer pages
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "LICENSE"

!insertmacro MUI_PAGE_COMPONENTS
!insertmacro MUI_PAGE_DIRECTORY

!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

;Uninstaller pages
!insertmacro MUI_UNPAGE_WELCOME
!insertmacro MUI_UNPAGE_CONFIRM
;!insertmacro MUI_UNPAGE_LICENSE textfile
;!insertmacro MUI_UNPAGE_COMPONENTS
!insertmacro MUI_UNPAGE_DIRECTORY
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

;--------------------------------
;Languages
  !insertmacro MUI_LANGUAGE "English"

Function .onInit
  ${IfNot} ${AtLeastWin10}
    MessageBox MB_OK "Windows 10 or later required, 64 bit only"
    Quit
  ${EndIf}
  ${IfNot} ${RunningX64}
    MessageBox MB_OK "64 bit Windows 10 or later required, 32 bit is not supported"
    Quit
  ${EndIf}
FunctionEnd

Section "Base Install" SEC01
    SectionIn RO
    ; Delete the old program
    RMDir /r $INSTDIR
    CreateDirectory $INSTDIR
    SetOutPath $INSTDIR
    writeUninstaller "$INSTDIR\uninstall.exe"
    File "files\icons\{{ MAJOR_VERSION }}.ico"

    ; PT:CLI
    SetOutPath $INSTDIR\{{ MAJOR_VERSION }}_cli
    File /r "dist\{{ MAJOR_VERSION }}_cli\"
    EnVar::SetHKLM
    EnVar::AddValue "path" "$INSTDIR\{{ MAJOR_VERSION }}_cli"
    ; PT:CLI

    ; PT:QT
    SetOutPath $INSTDIR\{{ MAJOR_VERSION }}_qt
    File /r "dist\{{ MAJOR_VERSION }}_qt\"
    ; PT:QT

    ; PT:SDL2
    SetOutPath $INSTDIR\{{ MAJOR_VERSION }}_sdl2
    File /r "dist\{{ MAJOR_VERSION }}_sdl2\"
    ; PT:SDL2

    ; Add to the "Add or remove programs" dialog
    WriteRegStr HKLM \
        "Software\Microsoft\Windows\CurrentVersion\Uninstall\{{ MAJOR_VERSION }}" \
        "DisplayName" \
        "{{ MAJOR_VERSION }}"
    WriteRegStr HKLM \
        "Software\Microsoft\Windows\CurrentVersion\Uninstall\{{ MAJOR_VERSION }}" \
        "DisplayIcon" \
        "$\"$INSTDIR\{{ MAJOR_VERSION }}.ico$\""
    WriteRegStr HKLM \
        "Software\Microsoft\Windows\CurrentVersion\Uninstall\{{ MAJOR_VERSION }}" \
        "UninstallString" \
        "$\"$INSTDIR\uninstall.exe$\""
    ; PT:SERVICE
    ExecWait 'sc create ${serviceName} error= "severe" displayname= "${displayName}" type= "own" start= "auto" binpath= "$INSTDIR\{{ MAJOR_VERSION }}_cli\{{ MAJOR_VERSION }}_cli.exe"'

    ; PT:SERVICE
SectionEnd

Section "Start Menu Shortcut" SEC02
    ; PT:QT
    createShortCut \
      "$SMPROGRAMS\{{ MAJOR_VERSION }}_qt.lnk" \
      "$INSTDIR\{{ MAJOR_VERSION }}_qt\{{ MAJOR_VERSION }}_qt.exe" \
      "" \
      "$INSTDIR\{{ MAJOR_VERSION }}.ico"
    ; PT:QT
    ; PT:SDL2
    createShortCut \
      "$SMPROGRAMS\{{ MAJOR_VERSION }}_sdl2.lnk" \
      "$INSTDIR\{{ MAJOR_VERSION }}_sdl2\{{ MAJOR_VERSION }}_sdl2.exe" \
      "" \
      "$INSTDIR\{{ MAJOR_VERSION }}.ico"
    ; PT:SDL2
SectionEnd

Section "uninstall"
    RMDir /r $INSTDIR
    ; PT:QT
    Delete "$SMPROGRAMS\{{ MAJOR_VERSION }}_qt.lnk"
    ; PT:QT
    ; PT:SDL2
    Delete "$SMPROGRAMS\{{ MAJOR_VERSION }}_sdl2.lnk"
    ; PT:SDL2
    ; PT:CLI
    EnVar::SetHKLM
    EnVar::DeleteValue "path" "$INSTDIR\{{ MAJOR_VERSION }}_cli"
    ; PT:CLI
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\{{ MAJOR_VERSION }}"
SectionEnd

